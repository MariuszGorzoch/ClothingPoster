<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Job Monitor</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1173d4",
              "background-light": "#f6f7f8",
              "background-dark": "#101922",
            },
            fontFamily: {
              display: ["Manrope"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      body {
        min-height: max(884px, 100dvh);
      }
    </style>
  </head>
  <body class="bg-background-light dark:bg-background-dark font-display">
    <div class="min-h-screen flex flex-col">
      <div class="flex-grow overflow-y-auto">
        <header
          class="sticky top-0 bg-background-light dark:bg-background-dark/80 backdrop-blur-sm z-10 px-4 pt-6 pb-4"
        >
          <div class="flex items-center justify-between gap-4">
            <h1 class="text-2xl font-bold text-black dark:text-white">Jobs</h1>
            <div class="flex items-center gap-3">
              <button
                class="flex items-center gap-2 rounded-full border border-black/10 dark:border-white/10 px-4 py-2 text-sm font-medium text-black dark:text-white hover:bg-primary/10 transition-colors"
                id="refresh-jobs"
                type="button"
              >
                <svg
                  class="size-4"
                  fill="none"
                  height="24"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                  width="24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path d="M21 2v6h-6" />
                  <path d="M3 12a9 9 0 0 1 15-6l3 3M3 22v-6h6" />
                  <path d="M21 12a9 9 0 0 1-15 6l-3-3" />
                </svg>
                Refresh
              </button>
              <button
                aria-label="Close"
                class="flex size-12 items-center justify-center rounded-full bg-black/5 text-black transition hover:bg-black/10 dark:bg-white/10 dark:text-white dark:hover:bg-white/20"
                onclick="window.location.href='index.html';"
                type="button"
              >
                <span class="material-symbols-outlined text-3xl leading-none">
                  close
                </span>
              </button>
            </div>
          </div>
        </header>
        <main class="px-4 pb-32">
          <section
            class="space-y-3"
            id="jobs-container"
            role="list"
            aria-live="polite"
          ></section>
        </main>
      </div>
      
    </div>
    <script>
      const jobsContainer = document.getElementById("jobs-container");
      const refreshButton = document.getElementById("refresh-jobs");
      const JOB_ENDPOINT = "https://localhost:7168/jobs";

      const jobCodeMap = {
        0: "Unknown",
        1: "AttributeExtractor",
        2: "FaceBookDraftPost",
      };

      const jobStatusMap = {
        0: "Pending",
        1: "In Progress",
        2: "Completed",
        3: "Error",
      };

      function renderPlaceholder(message) {
        const card = document.createElement("div");
        card.className =
          "p-4 rounded-lg bg-white dark:bg-background-dark/50 border border-black/10 dark:border-white/10 text-gray-600 dark:text-gray-300";
        card.textContent = message;
        jobsContainer.innerHTML = "";
        jobsContainer.appendChild(card);
      }

      function getStatusClasses(statusLabel) {
        const lightBackgrounds = {
          Pending: "bg-white",
          "In Progress": "bg-yellow-50",
          Completed: "bg-green-50",
          Error: "bg-red-50",
          Unknown: "bg-white",
        };

        const darkBackgrounds = {
          Pending: "dark:bg-white/10",
          "In Progress": "dark:bg-yellow-400/10",
          Completed: "dark:bg-green-400/10",
          Error: "dark:bg-red-400/10",
          Unknown: "dark:bg-white/10",
        };

        return `${lightBackgrounds[statusLabel] ?? lightBackgrounds.Unknown} ${
          darkBackgrounds[statusLabel] ?? darkBackgrounds.Unknown
        }`;
      }

      function renderJob(job) {
        const card = document.createElement("article");
        const statusLabel = jobStatusMap[job.Status] ?? "Unknown";
        card.className = `p-4 rounded-lg border border-transparent hover:border-primary/40 hover:bg-primary/5 transition-colors ${getStatusClasses(
          statusLabel
        )}`;
        card.setAttribute("role", "listitem");
        card.setAttribute(
          "aria-label",
          `${job.Name ?? "Unnamed job"} is ${statusLabel}`
        );

        const header = document.createElement("div");
        header.className = "flex items-start gap-4";

        const title = document.createElement("div");
        title.innerHTML = `
          <p class="text-base font-semibold text-black dark:text-white">${
            job.Name ?? "Unnamed job"
          }</p>
        `;
        header.appendChild(title);

        const meta = document.createElement("dl");
        meta.className = "mt-4 grid grid-cols-1 gap-3 text-sm text-gray-600 dark:text-gray-300 sm:grid-cols-2";
        const fields = [
          { label: "Code", value: jobCodeMap[job.Code] ?? job.Code ?? "Unknown" },
          { label: "Created", value: job.CreatedAt ? new Date(job.CreatedAt).toLocaleString() : "-" },
          { label: "Completed", value: job.CompletedAt ? new Date(job.CompletedAt).toLocaleString() : "-" },
          { label: "Result", value: job.Result ? job.Result : "â€”" },
        ];

        fields.forEach((field) => {
          const wrapper = document.createElement("div");
          const dt = document.createElement("dt");
          dt.className = "text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400";
          dt.textContent = field.label;
          const dd = document.createElement("dd");
          dd.className = "mt-1 text-sm text-black dark:text-white/80 break-words";
          dd.textContent = field.value;
          wrapper.appendChild(dt);
          wrapper.appendChild(dd);
          meta.appendChild(wrapper);
        });

        card.appendChild(header);
        card.appendChild(meta);

        return card;
      }

      async function fetchJobs() {
        renderPlaceholder("Loading jobs...");
        try {
          const response = await fetch(JOB_ENDPOINT, {
            headers: {
              Accept: "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`Failed to fetch jobs (${response.status})`);
          }

          const jobs = await response.json();

          if (!Array.isArray(jobs) || jobs.length === 0) {
            renderPlaceholder("No jobs available yet.");
            return;
          }

          jobsContainer.innerHTML = "";
          jobs
            .sort((a, b) => {
              const dateA = a.CreatedAt ? new Date(a.CreatedAt).getTime() : 0;
              const dateB = b.CreatedAt ? new Date(b.CreatedAt).getTime() : 0;
              return dateB - dateA;
            })
            .forEach((job) => {
              jobsContainer.appendChild(renderJob(job));
            });
        } catch (error) {
          console.error(error);
          renderPlaceholder("We couldn't load jobs. Please try again.");
        }
      }

      refreshButton?.addEventListener("click", fetchJobs);

      fetchJobs();
    </script>
  </body>
</html>
