<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta content="default" name="apple-mobile-web-app-status-bar-style" />
    <meta content="yes" name="mobile-web-app-capable" />
    <meta content="Clothing Poster" name="apple-mobile-web-app-title" />
    <link href="MoniTTa.jpg" rel="apple-touch-icon" />
    <title>Clothing Poster</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script defer src="pwa.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1173d4",
              "background-light": "#f6f7f8",
              "background-dark": "#101922",
            },
            fontFamily: {
              display: ["Manrope"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      body {
        min-height: max(884px, 100dvh);
      }
    </style>
  </head>
  <body class="bg-background-light dark:bg-background-dark font-display">
    <div class="flex min-h-[100dvh] flex-col">
      <div class="flex-1 overflow-y-auto">
        <header
          class="sticky top-0 bg-background-light dark:bg-background-dark/80 backdrop-blur-sm z-10 px-4 pt-6 pb-4"
        >
          <div class="flex items-center justify-between gap-4">
            <h1 class="text-2xl font-bold text-black dark:text-white">Zadania</h1>
            <button
              aria-label="Zamknij"
              class="flex size-12 items-center justify-center rounded-full bg-black/5 text-black transition hover:bg-black/10 dark:bg-white/10 dark:text-white dark:hover:bg-white/20"
              onclick="window.location.href='index.html';"
              type="button"
            >
              <span class="material-symbols-outlined text-3xl leading-none">
                close
              </span>
            </button>
          </div>
        </header>
        <main class="px-4 pb-4">
          <section
            class="space-y-3"
            id="jobs-container"
            role="list"
            aria-live="polite"
          ></section>
        </main>
      </div>
      <footer class="sticky bottom-0 bg-background-light dark:bg-background-dark/80 backdrop-blur-sm border-t border-black/10 dark:border-white/10">
        <nav class="flex justify-center items-center h-16">
          <button
            class="flex flex-col items-center gap-1 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors"
            id="refresh-jobs"
            type="button"
          >
            <span aria-hidden="true" class="material-symbols-outlined text-2xl leading-none">refresh</span>
            <span class="text-xs font-medium">Odśwież</span>
          </button>
        </nav>
        <div class="pb-safe"></div>
      </footer>
    </div>
    <script>
      const jobsContainer = document.getElementById("jobs-container");
      const refreshButton = document.getElementById("refresh-jobs");
      const JOB_ENDPOINT = "https://clothingposterappservice-ada8b4eahpfxbrd6.polandcentral-01.azurewebsites.net/jobs";

      const jobCodeMap = {
        0: "Nieznany",
        1: "Wyodrębnianie atrybutów",
        2: "Szkic posta na Facebooku",
      };

      const jobStatusMap = {
        0: "Oczekujące",
        1: "W trakcie",
        2: "Zakończone",
        3: "Błąd",
      };

      function renderPlaceholder(message) {
        const card = document.createElement("div");
        card.className =
          "p-4 rounded-lg bg-white dark:bg-background-dark/50 border border-black/10 dark:border-white/10 text-gray-600 dark:text-gray-300";
        card.textContent = message;
        jobsContainer.innerHTML = "";
        jobsContainer.appendChild(card);
      }

      function getStatusClasses(statusLabel) {
        const lightBackgrounds = {
          Oczekujące: "bg-white",
          "W trakcie": "bg-yellow-50",
          Zakończone: "bg-green-50",
          Błąd: "bg-red-50",
          Nieznany: "bg-white",
        };

        const darkBackgrounds = {
          Oczekujące: "dark:bg-white/10",
          "W trakcie": "dark:bg-yellow-400/10",
          Zakończone: "dark:bg-green-400/10",
          Błąd: "dark:bg-red-400/10",
          Nieznany: "dark:bg-white/10",
        };

        return `${lightBackgrounds[statusLabel] ?? lightBackgrounds.Nieznany} ${
          darkBackgrounds[statusLabel] ?? darkBackgrounds.Nieznany
        }`;
      }

      function renderJob(job) {
        const card = document.createElement("article");
        const statusLabel = jobStatusMap[job.Status] ?? "Nieznany";
        card.className = `p-4 rounded-lg border border-transparent hover:border-primary/40 hover:bg-primary/5 transition-colors ${getStatusClasses(
          statusLabel
        )}`;
        card.setAttribute("role", "listitem");
        card.setAttribute(
          "aria-label",
          `${job.Name ?? "Zadanie bez nazwy"} – ${statusLabel}`
        );

        const header = document.createElement("div");
        header.className = "flex items-start gap-4";

        const title = document.createElement("div");
        title.innerHTML = `
          <p class="text-base font-semibold text-black dark:text-white">${
            job.Name ?? "Zadanie bez nazwy"
          }</p>
        `;
        header.appendChild(title);

        const meta = document.createElement("dl");
        meta.className = "mt-4 grid grid-cols-1 gap-3 text-sm text-gray-600 dark:text-gray-300 sm:grid-cols-2";
        const fields = [
          { label: "Kod", value: jobCodeMap[job.Code] ?? job.Code ?? "Nieznany" },
          { label: "Utworzono", value: job.CreatedAt ? new Date(job.CreatedAt).toLocaleString() : "-" },
          { label: "Zakończono", value: job.CompletedAt ? new Date(job.CompletedAt).toLocaleString() : "-" },
          { label: "Wynik", value: job.Result ? job.Result : "—" },
        ];

        fields.forEach((field) => {
          const wrapper = document.createElement("div");
          const dt = document.createElement("dt");
          dt.className = "text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400";
          dt.textContent = field.label;
          const dd = document.createElement("dd");
          dd.className = "mt-1 text-sm text-black dark:text-white/80 break-words";
          dd.textContent = field.value;
          wrapper.appendChild(dt);
          wrapper.appendChild(dd);
          meta.appendChild(wrapper);
        });

        card.appendChild(header);
        card.appendChild(meta);

        return card;
      }

      async function fetchJobs({ showLoading = true } = {}) {
        if (showLoading) {
          renderPlaceholder("Wczytywanie zadań...");
        }
        try {
          const response = await fetch(JOB_ENDPOINT, {
            headers: {
              Accept: "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`Nie udało się pobrać zadań (${response.status})`);
          }

          const jobs = await response.json();

          if (!Array.isArray(jobs) || jobs.length === 0) {
            renderPlaceholder("Brak dostępnych zadań.");
            return;
          }

          jobsContainer.innerHTML = "";
          jobs
            .sort((a, b) => {
              const dateA = a.CreatedAt ? new Date(a.CreatedAt).getTime() : 0;
              const dateB = b.CreatedAt ? new Date(b.CreatedAt).getTime() : 0;
              return dateB - dateA;
            })
            .forEach((job) => {
              jobsContainer.appendChild(renderJob(job));
            });
        } catch (error) {
          console.error(error);
          renderPlaceholder("Nie udało się wczytać zadań. Spróbuj ponownie.");
        }
      }

      refreshButton?.addEventListener("click", () => fetchJobs());

      fetchJobs();

      const REFRESH_INTERVAL_MS = 5000;
      setInterval(() => {
        fetchJobs({ showLoading: false });
      }, REFRESH_INTERVAL_MS);
    </script>
  </body>
</html>
