<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1173d4",
              "background-light": "#f6f7f8",
              "background-dark": "#101922",
            },
            fontFamily: {
              display: ["Manrope"],
            },
            borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
          },
        },
      };
    </script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<title>Stitch Design</title>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="font-display bg-background-light dark:bg-background-dark">
<div class="flex flex-col h-screen justify-between">
<main class="flex-grow">
<header class="sticky top-0 bg-background-light dark:bg-background-dark/80 backdrop-blur-sm z-10 px-4 pt-6 pb-4">
  <div class="flex items-center justify-between gap-4">
    <h1 class="text-2xl font-bold text-black dark:text-white">Add Product</h1>
    <button
      class="flex size-12 items-center justify-center rounded-full bg-black/5 text-black transition hover:bg-black/10 dark:bg-white/10 dark:text-white dark:hover:bg-white/20"
      id="closeButton"
      type="button"
      aria-label="Close"
    >
      <span class="material-symbols-outlined text-3xl leading-none"> close </span>
    </button>
  </div>
</header>
<section class="p-4 space-y-4">
<h2 class="font-bold text-lg text-black dark:text-white">Add photos</h2>
<div class="flex flex-col items-center justify-center space-y-4 border-2 border-dashed border-primary/40 dark:border-primary/60 rounded-lg p-14 text-center">
<span class="material-symbols-outlined text-5xl text-primary">add_photo_alternate</span>
<div class="space-y-1">
<p class="font-bold text-lg text-black dark:text-white">Add photos</p>
<p class="text-sm text-black/60 dark:text-white/60">Add up to 5 photos of your product</p>
</div>
<input accept="image/*" class="hidden" id="productPhotos" multiple type="file"/>
<button class="bg-primary/20 dark:bg-primary/30 text-primary font-bold py-2 px-4 rounded-full text-sm" id="addPhotosButton" type="button">
              Add photos
            </button>
</div>
<div class="mt-4" id="photoPreview" role="list"></div>
</section>
<div class="fixed bottom-20 w-full px-4 py-3">
<button class="w-full bg-primary text-white font-bold py-3 px-5 rounded-lg text-base disabled:opacity-50 disabled:cursor-not-allowed" id="createProductButton" type="button">
            Create Product
          </button>
</div>
</main>
</div>
<script>
    const addPhotosButton = document.getElementById("addPhotosButton");
    const productPhotosInput = document.getElementById("productPhotos");
    const photoPreview = document.getElementById("photoPreview");
    const createProductButton = document.getElementById("createProductButton");
    const closeButton = document.getElementById("closeButton");
    const MAX_PHOTOS = 5;
    let selectedFiles = [];

    const updateCreateButtonState = () => {
      createProductButton.disabled = productPhotosInput.files.length === 0;
    };

    const syncInputFiles = () => {
      const dataTransfer = new DataTransfer();
      selectedFiles.forEach((file) => dataTransfer.items.add(file));
      productPhotosInput.files = dataTransfer.files;
      updateCreateButtonState();
    };

    const renderPreview = () => {
      photoPreview.innerHTML = "";

      if (selectedFiles.length === 0) {
        photoPreview.className = "mt-4";
        return;
      }

      photoPreview.className = "mt-4 space-y-3";

      selectedFiles.forEach((file, index) => {
        const previewItem = document.createElement("div");
        previewItem.className = "relative w-full rounded-lg overflow-hidden border border-black/10 dark:border-white/10";
        previewItem.setAttribute("role", "listitem");

        const removeButton = document.createElement("button");
        removeButton.type = "button";
        removeButton.className = "absolute top-3 right-3 bg-black/70 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm";
        removeButton.setAttribute("aria-label", `Remove ${file.name}`);
        removeButton.textContent = "âœ•";
        removeButton.addEventListener("click", () => {
          selectedFiles = selectedFiles.filter((_, fileIndex) => fileIndex !== index);
          syncInputFiles();
          renderPreview();
        });

        const image = document.createElement("img");
        image.alt = file.name;
        image.className = "w-full h-auto object-cover";

        const reader = new FileReader();
        reader.onload = (event) => {
          image.src = event.target.result;
        };
        reader.readAsDataURL(file);

        previewItem.appendChild(image);
        previewItem.appendChild(removeButton);
        photoPreview.appendChild(previewItem);
      });
    };

    addPhotosButton.addEventListener("click", () => {
      productPhotosInput.click();
    });

    productPhotosInput.addEventListener("change", (event) => {
      const incomingFiles = Array.from(event.target.files);
      productPhotosInput.value = "";
      let limitExceeded = false;

      incomingFiles.forEach((file) => {
        const isDuplicate = selectedFiles.some(
          (existingFile) =>
            existingFile.name === file.name &&
            existingFile.size === file.size &&
            existingFile.lastModified === file.lastModified
        );

        if (isDuplicate) {
          return;
        }

        if (selectedFiles.length >= MAX_PHOTOS) {
          limitExceeded = true;
          return;
        }

        selectedFiles.push(file);
      });

      if (limitExceeded) {
        alert(`You can only select up to ${MAX_PHOTOS} photos.`);
      }

      syncInputFiles();
      renderPreview();
    });

    const setCreateButtonState = (isSubmitting) => {
      if (isSubmitting) {
        createProductButton.disabled = true;
        createProductButton.dataset.originalText = createProductButton.textContent;
        createProductButton.textContent = "Uploading...";
      } else {
        createProductButton.disabled = selectedFiles.length === 0;
        if (createProductButton.dataset.originalText) {
          createProductButton.textContent = createProductButton.dataset.originalText;
          delete createProductButton.dataset.originalText;
        }
      }
    };

    createProductButton.addEventListener("click", async () => {
      if (selectedFiles.length === 0) {
        return;
      }

      const formData = new FormData();
      selectedFiles.forEach((file, index) => {
        formData.append(`file${index + 1}`, file);
      });

      try {
        setCreateButtonState(true);
        const response = await fetch("https://localhost:7168/products/add", {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          throw new Error("Failed to upload product images.");
        }

        window.location.href = "index.html";
      } catch (error) {
        console.error(error);
        alert("There was a problem uploading the product. Please try again.");
        setCreateButtonState(false);
      }
    });

    syncInputFiles();
    renderPreview();

    closeButton.addEventListener("click", () => {
      window.location.href = "index.html";
    });
  </script>
</body></html>
