<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<title>Stitch Design</title>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#1173d4",
            "background-light": "#f6f7f8",
            "background-dark": "#101922",
          },
          fontFamily: {
            display: ["Manrope"],
          },
          borderRadius: {
            DEFAULT: "0.25rem",
            lg: "0.5rem",
            xl: "0.75rem",
            full: "9999px"
          },
        },
      },
    };
  </script>
<style>
    .form-input {
      appearance: none;
      background-color: transparent;
      border-width: 0;
      padding: 0;
      margin: 0;
      box-sizing: border-box;
    }
    .form-input:focus {
      outline: none;
      box-shadow: none;
    }
  </style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="flex flex-col min-h-screen">
<header class="sticky top-0 bg-background-light dark:bg-background-dark/80 backdrop-blur-sm z-10 px-4 pt-6 pb-4">
  <div class="flex items-center justify-between gap-4">
    <h1 class="text-2xl font-bold text-black dark:text-white">Manage Product</h1>
    <button
      class="flex size-12 items-center justify-center rounded-full bg-black/5 text-black transition hover:bg-black/10 dark:bg-white/10 dark:text-white dark:hover:bg-white/20"
      onclick="window.location.href='index.html';"
      type="button"
      aria-label="Close"
    >
      <span class="material-symbols-outlined text-3xl leading-none"> close </span>
    </button>
  </div>
</header>
<main class="flex-grow">
<div class="w-full px-4 py-6">
<div class="relative aspect-[3/4] w-full rounded-xl overflow-hidden mb-6">
<div class="absolute inset-0 flex overflow-x-auto snap-x snap-mandatory" id="image-slider"></div>
<div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2" id="image-indicators"></div>
</div>
<div class="space-y-4">
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="product-title">Title</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="product-title" placeholder="e.g. Classic Blue Jeans" type="text"/>
</div>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="category">Category</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="category" placeholder="e.g. Jeans" type="text"/>
</div>
</div>
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="brand">Brand</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="brand" placeholder="e.g. Levi's" type="text"/>
</div>
</div>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="model">Model</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="model" placeholder="e.g. 501" type="text"/>
</div>
</div>
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="colors">Colors</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="colors" placeholder="e.g. Blue, Indigo" type="text"/>
</div>
</div>
</div>
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="materials">Materials</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="materials" placeholder="e.g. Denim, Cotton" type="text"/>
</div>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="pattern">Pattern</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="pattern" placeholder="e.g. Solid" type="text"/>
</div>
</div>
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="condition">Condition</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="condition" placeholder="e.g. Excellent" type="text"/>
</div>
</div>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="size-label">Size Label</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="size-label" placeholder="e.g. M, 32x32" type="text"/>
</div>
</div>
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="fit">Fit</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="fit" placeholder="e.g. Straight Leg" type="text"/>
</div>
</div>
</div>
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60">Measurements (cm)</label>
<div class="grid grid-cols-3 gap-2 mt-1">
<div>
<div class="bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="measurement-chest" placeholder="Chest" type="number"/>
</div>
</div>
<div>
<div class="bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="measurement-waist" placeholder="Waist" type="number"/>
</div>
</div>
<div>
<div class="bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="measurement-hip" placeholder="Hip" type="number"/>
</div>
</div>
<div>
<div class="bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="measurement-length" placeholder="Length" type="number"/>
</div>
</div>
<div>
<div class="bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="measurement-sleeve" placeholder="Sleeve" type="number"/>
</div>
</div>
<div>
<div class="bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="measurement-shoulder" placeholder="Shoulder" type="number"/>
</div>
</div>
</div>
</div>
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="style">Style</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<input class="w-full h-12 px-4 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40" id="style" placeholder="e.g. Classic, Vintage" type="text"/>
</div>
</div>
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="notable-details">Notable Details</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<textarea class="w-full px-4 py-3 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40 resize-none" id="notable-details" placeholder="e.g. Red tab, button fly" rows="2"></textarea>
</div>
</div>
<div>
<label class="text-sm font-medium text-black/60 dark:text-white/60" for="defects">Defects</label>
<div class="mt-1 bg-white/5 dark:bg-white/5 rounded-lg border border-black/10 dark:border-white/10">
<textarea class="w-full px-4 py-3 bg-transparent text-black dark:text-white placeholder-black/40 dark:placeholder-white/40 resize-none" id="defects" placeholder="e.g. Small fraying on cuff" rows="2"></textarea>
</div>
</div>

      <div class="pt-6 border-t border-black/10 dark:border-white/10 hidden" id="facebook-draft-section">
        <h2 class="text-sm font-medium text-black/60 dark:text-white/60">Facebook draft link</h2>
        <a
          class="mt-2 inline-flex items-center text-primary break-all"
          href="#"
          id="facebook-draft-link"
          rel="noopener noreferrer"
          target="_blank"
        ></a>
      </div>
</div>
</div>
</main>
<footer class="sticky bottom-0 bg-background-light dark:bg-background-dark/80 backdrop-blur-sm border-t border-black/10 dark:border-white/10">
  <nav class="flex justify-around items-center h-16 px-2">
    <button class="flex flex-col items-center justify-center gap-1 p-0 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" id="save-product" type="button">
      <span class="material-symbols-outlined text-2xl leading-none">save</span>
      <span class="text-xs font-medium">Save product</span>
    </button>
    <button class="flex flex-col items-center justify-center gap-1 p-0 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" id="refresh-product" type="button">
      <span class="material-symbols-outlined text-2xl leading-none">refresh</span>
      <span class="text-xs font-medium">Refresh product</span>
    </button>
    <button class="flex flex-col items-center justify-center gap-1 p-0 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" id="extract-job" type="button">
      <span class="material-symbols-outlined text-2xl leading-none">precision_manufacturing</span>
      <span class="text-xs font-medium">Extract Job</span>
    </button>
    <button class="flex flex-col items-center justify-center gap-1 p-0 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" id="facebook-job" type="button">
      <span class="material-symbols-outlined text-2xl leading-none">share</span>
      <span class="text-xs font-medium">Facebook Job</span>
    </button>
    <button class="flex flex-col items-center justify-center gap-1 p-0 text-red-500 dark:text-red-400 hover:text-red-600 dark:hover:text-red-300 transition-colors" id="delete-product" type="button">
      <span class="material-symbols-outlined text-2xl leading-none">delete</span>
      <span class="text-xs font-medium">Delete</span>
    </button>
  </nav>
  <div class="pb-safe"></div>
</footer>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const slider = document.getElementById('image-slider');
    const indicators = document.getElementById('image-indicators');
    const params = new URLSearchParams(window.location.search);
    const productId = params.get('productId');
    const deleteButton = document.getElementById('delete-product');
    const saveButton = document.getElementById('save-product');
    const facebookJobButton = document.getElementById('facebook-job');
    const refreshButton = document.getElementById('refresh-product');
    const extractJobButton = document.getElementById('extract-job');

    if (!productId) {
      console.warn('No productId provided in the query string.');
      return;
    }

    if (deleteButton) {
      deleteButton.addEventListener('click', async () => {
        const confirmed = window.confirm('Are you sure you want to delete this product?');

        if (!confirmed) {
          return;
        }

        try {
          const response = await fetch(`https://localhost:7168/products/${encodeURIComponent(productId)}`, {
            method: 'DELETE',
          });

          if (!response.ok) {
            throw new Error(`Failed to delete product. Status: ${response.status}`);
          }

          window.location.href = 'index.html';
        } catch (error) {
          console.error('Unable to delete product.', error);
          window.alert('Unable to delete the product. Please try again.');
        }
      });
    }

    if (refreshButton) {
      refreshButton.addEventListener('click', () => {
        fetchProduct(productId);
      });
    }

    if (extractJobButton) {
      extractJobButton.addEventListener('click', async () => {
        try {
          const response = await fetch(`https://localhost:7168/products/${encodeURIComponent(productId)}/extract-job`, {
            method: 'POST',
            headers: {
              Accept: 'application/json',
            },
          });

          if (!response.ok) {
            throw new Error(`Failed to start extract job. Status: ${response.status}`);
          }

          window.alert('Extract job started successfully.');
          await fetchProduct(productId);
        } catch (error) {
          console.error('Unable to start extract job.', error);
          window.alert('Unable to start the extract job. Please try again.');
        }
      });
    }

    fetchProduct(productId);

    if (facebookJobButton) {
      facebookJobButton.addEventListener('click', async () => {
        try {
          const payload = buildPayload();

          const response = await fetch(`https://localhost:7168/products/${encodeURIComponent(productId)}/publish-fb-draft`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`Failed to update product. Status: ${response.status}`);
          }

          window.location.href = 'index.html';
        } catch (error) {
          console.error('Unable to update product.', error);
          window.alert('Unable to save the product changes. Please try again.');
        }
      });
    }

    if (saveButton) {
      saveButton.addEventListener('click', async () => {
        try {
          const payload = buildPayload();

          const response = await fetch(`https://localhost:7168/products/${encodeURIComponent(productId)}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`Failed to update product. Status: ${response.status}`);
          }

          window.location.href = 'index.html';
        } catch (error) {
          console.error('Unable to update product.', error);
          window.alert('Unable to save the product changes. Please try again.');
        }
      });
    }

    async function fetchProduct(id) {
      try {
        const response = await fetch(`https://localhost:7168/products/${encodeURIComponent(id)}`);

        if (!response.ok) {
          throw new Error(`Failed to fetch product. Status: ${response.status}`);
        }

        const product = await response.json();
        populateFields(product);
        populateImages(Array.isArray(product?.Images) ? product.Images : []);
      } catch (error) {
        console.error('Unable to load product details.', error);
        populateImages([]);
      }
    }

    function populateFields(product) {
      const attributes = product?.Attributes ?? {};

      const fieldMap = {
        'product-title': attributes.Title,
        category: attributes.Category,
        brand: attributes.Brand,
        model: attributes.Model,
        colors: attributes.Colors,
        materials: attributes.Materials,
        pattern: attributes.Pattern,
        condition: attributes.Condition,
        'size-label': attributes.SizeLabel,
        fit: attributes.Fit,
        style: attributes.Style,
      };

      Object.entries(fieldMap).forEach(([id, value]) => {
        const element = document.getElementById(id);

        if (element) {
          element.value = value ?? '';
        }
      });

      const measurements = {
        'measurement-chest': attributes.ChestCm,
        'measurement-waist': attributes.WaistCm,
        'measurement-hip': attributes.HipCm,
        'measurement-length': attributes.LengthCm,
        'measurement-sleeve': attributes.SleeveCm,
        'measurement-shoulder': attributes.ShoulderCm,
      };

      Object.entries(measurements).forEach(([id, value]) => {
        const element = document.getElementById(id);

        if (element) {
          element.value = value ?? '';
        }
      });

      const notableDetails = document.getElementById('notable-details');
      const defects = document.getElementById('defects');

      if (notableDetails) {
        notableDetails.value = attributes.NotableDetails ?? '';
      }

      if (defects) {
        defects.value = attributes.Defects ?? '';
      }

      const facebookDraftSection = document.getElementById('facebook-draft-section');
      const facebookDraftLink = document.getElementById('facebook-draft-link');

      if (facebookDraftSection && facebookDraftLink) {
        const draftUrl = typeof product?.FacebookPostDraftUrl === 'string' ? product.FacebookPostDraftUrl.trim() : '';

        if (draftUrl) {
          facebookDraftLink.href = draftUrl;
          facebookDraftLink.textContent = draftUrl;
          facebookDraftSection.classList.remove('hidden');
        } else {
          facebookDraftLink.removeAttribute('href');
          facebookDraftLink.textContent = '';
          if (!facebookDraftSection.classList.contains('hidden')) {
            facebookDraftSection.classList.add('hidden');
          }
        }
      }
    }

    let sliderInitialized = false;

    function populateImages(images) {
      if (!slider || !indicators) {
        return;
      }

      slider.innerHTML = '';
      indicators.innerHTML = '';

      if (!images.length) {
        const placeholder = document.createElement('div');
        placeholder.className = 'flex-shrink-0 w-full h-full snap-center bg-background-light dark:bg-background-dark flex items-center justify-center text-black/60 dark:text-white/60';
        placeholder.textContent = 'No images available';
        slider.appendChild(placeholder);
        return;
      }

      images.forEach((url, index) => {
        const slide = document.createElement('div');
        slide.className = 'flex-shrink-0 w-full h-full snap-center bg-cover bg-center';
        slide.style.backgroundImage = `url("${url}")`;
        slider.appendChild(slide);

        const indicator = document.createElement('div');
        indicator.className = `w-2 h-2 rounded-full ${index === 0 ? 'bg-white' : 'bg-white/50'}`;
        indicators.appendChild(indicator);
      });

      slider.scrollTo({ left: 0 });
      updateIndicators();
      if (!sliderInitialized) {
        slider.addEventListener('scroll', handleSliderScroll, { passive: true });
        sliderInitialized = true;
      }
    }

    let scrollTicking = false;

    function handleSliderScroll() {
      if (!scrollTicking) {
        scrollTicking = true;
        window.requestAnimationFrame(() => {
          updateIndicators();
          scrollTicking = false;
        });
      }
    }

    function updateIndicators() {
      if (!slider || !indicators || !indicators.children.length) {
        return;
      }

      const slideWidth = slider.clientWidth || 1;
      const activeIndex = Math.round((slider.scrollLeft || 0) / slideWidth);

      Array.from(indicators.children).forEach((indicator, index) => {
        indicator.className = `w-2 h-2 rounded-full ${index === activeIndex ? 'bg-white' : 'bg-white/50'}`;
      });
    }

    function buildPayload() {
      const getValue = (id) => {
        const element = document.getElementById(id);
        return element ? element.value.trim() : '';
      };

      const parseMeasurement = (id) => {
        const rawValue = getValue(id);

        if (rawValue === '') {
          return 0;
        }

        const numericValue = Number(rawValue);
        return Number.isFinite(numericValue) ? numericValue : 0;
      };

      return {
        Attributes: {
          Title: getValue('product-title'),
          Category: getValue('category'),
          Brand: getValue('brand'),
          Model: getValue('model'),
          Colors: getValue('colors'),
          Materials: getValue('materials'),
          Pattern: getValue('pattern'),
          Condition: getValue('condition'),
          SizeLabel: getValue('size-label'),
          ChestCm: parseMeasurement('measurement-chest'),
          WaistCm: parseMeasurement('measurement-waist'),
          HipCm: parseMeasurement('measurement-hip'),
          LengthCm: parseMeasurement('measurement-length'),
          SleeveCm: parseMeasurement('measurement-sleeve'),
          ShoulderCm: parseMeasurement('measurement-shoulder'),
          Fit: getValue('fit'),
          Style: getValue('style'),
          NotableDetails: getValue('notable-details'),
          Defects: getValue('defects'),
        },
      };
    }
  });
</script>

</body>
</html>
